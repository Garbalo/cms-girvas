'user strict';

class Form {
	static icon_default = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 266.51 320"><defs></defs><title>emblem_drenom</title><g id="Слой_2" data-name="Слой 2"><g id="Слой_1-2" data-name="Слой 1"><path class="cls-1" d="M66.74,320H0V0H66.74Zm13.72-59.43h32c40.68,0,87.31-14.17,87.31-104.23,0-57.14-27.88-97.83-95.08-97.83H80.46V0h31.08C149.49,0,181,7.77,208,27.89c32.46,24.22,58.51,71.77,58.51,128C266.51,276.11,195.2,320,116.11,320H80.46Z"/><circle class="cls-1" cx="127.44" cy="165.15" r="39.47"/></g></g></svg>';
	static icon_success = '<?xml version="1.0" encoding="iso-8859-1"?><!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 viewBox="0 0 408.576 408.576" style="enable-background:new 0 0 408.576 408.576;" xml:space="preserve"><g>	<g>		<path d="M204.288,0C91.648,0,0,91.648,0,204.288s91.648,204.288,204.288,204.288s204.288-91.648,204.288-204.288			S316.928,0,204.288,0z M318.464,150.528l-130.56,129.536c-7.68,7.68-19.968,8.192-28.16,0.512L90.624,217.6			c-8.192-7.68-8.704-20.48-1.536-28.672c7.68-8.192,20.48-8.704,28.672-1.024l54.784,50.176L289.28,121.344			c8.192-8.192,20.992-8.192,29.184,0C326.656,129.536,326.656,142.336,318.464,150.528z"/>	</g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
	static icon_warning = '<?xml version="1.0" encoding="iso-8859-1"?><!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g>	<g>		<path d="M501.362,383.95L320.497,51.474c-29.059-48.921-99.896-48.986-128.994,0L10.647,383.95			c-29.706,49.989,6.259,113.291,64.482,113.291h361.736C495.039,497.241,531.068,433.99,501.362,383.95z M256,437.241			c-16.538,0-30-13.462-30-30c0-16.538,13.462-30,30-30c16.538,0,30,13.462,30,30C286,423.779,272.538,437.241,256,437.241z			 M286,317.241c0,16.538-13.462,30-30,30c-16.538,0-30-13.462-30-30v-150c0-16.538,13.462-30,30-30c16.538,0,30,13.462,30,30			V317.241z"/>	</g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
	static icon_info = '<?xml version="1.0" encoding="iso-8859-1"?><!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"	 width="459.319px" height="459.319px" viewBox="0 0 459.319 459.319" style="enable-background:new 0 0 459.319 459.319;"	 xml:space="preserve"><g>	<path d="M94.924,366.674h312.874c0.958,0,1.886-0.136,2.778-0.349c0.071,0,0.13,0.012,0.201,0.012		c6.679,0,12.105-5.42,12.105-12.104V12.105C422.883,5.423,417.456,0,410.777,0h-2.955H114.284H94.941		c-32.22,0-58.428,26.214-58.428,58.425c0,0.432,0.085,0.842,0.127,1.259c-0.042,29.755-0.411,303.166-0.042,339.109		c-0.023,0.703-0.109,1.389-0.109,2.099c0,30.973,24.252,56.329,54.757,58.245c0.612,0.094,1.212,0.183,1.847,0.183h317.683		c6.679,0,12.105-5.42,12.105-12.105v-45.565c0-6.68-5.427-12.105-12.105-12.105s-12.105,5.426-12.105,12.105v33.461H94.924		c-18.395,0-33.411-14.605-34.149-32.817c0.018-0.325,0.077-0.632,0.071-0.963c-0.012-0.532-0.03-1.359-0.042-2.459		C61.862,380.948,76.739,366.674,94.924,366.674z M103.178,58.425c0-6.682,5.423-12.105,12.105-12.105s12.105,5.423,12.105,12.105		V304.31c0,6.679-5.423,12.105-12.105,12.105s-12.105-5.427-12.105-12.105V58.425z"/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
	static icon_lamp = '<svg id="Capa_1" enable-background="new 0 0 512.001 512.001" height="512" viewBox="0 0 512.001 512.001" width="512" xmlns="http://www.w3.org/2000/svg"><g><path d="m158.668 417.001h194.713c1.259-10.062 2.591-21.882 3.64-34h-201.845c1.034 12.426 2.3 24.132 3.492 34z"/><path d="m255.671 511.998c.194.004.427.005.625 0 61.563-1.282 88.236-34.094 92.89-64.997h-186.406c4.656 30.903 31.329 63.714 92.891 64.997z"/><path d="m367.521 46.181c-30.249-30.037-70.323-46.505-112.68-46.176-86.641.61-157.454 72.049-157.855 159.248-.166 35.976 11.396 69.966 33.439 98.297 15.602 20.051 22.559 44.246 22.559 78.451 0 5.568.122 11.268.337 17h87.663v-122.787l-27.606-27.607c-5.858-5.858-5.858-15.355 0-21.213 5.857-5.858 15.355-5.858 21.213 0l21.394 21.394 21.394-21.394c5.857-5.858 15.355-5.858 21.213 0s5.858 15.355 0 21.213l-27.606 27.606v122.787h87.864c.088-3.073.136-6.083.136-9 0-37.295 7.787-67.71 21.926-85.642 49.782-63.142 44.854-154.342-13.391-212.177z"/></g></svg>';
	
	constructor(element) {
		this.id = element.id;
		this.form = element;
		this.method = this.getMethod();
		this.action = $(element).attr('action');
		
		let self_class = this;
		$(element).submit(function(e) {
			e.preventDefault();
			self_class.send();
		});
	}
	
	send() {
		let form_data = new FormData(this.form);
		let form_self = this.form;
		
		let input_files = $(form_self).find('input[type="file"]');
		for (let inputs = 0; inputs < input_files.length; inputs++) {
			if (input_files[inputs].hasAttribute('multiple')) {
				for (let input_file_i = 0; input_file_i < input_files[inputs].files.length; input_file_i++) {
					let file_data = input_files[inputs].files[input_file_i];
					form_data.append($(input_files[inputs]).attr('name') + '[]', file_data);
				}
			} else {
				let file_data = input_files[inputs].files[0];
				form_data.append($(input_files[inputs]).attr('name'), file_data);
			}
		}
		
		let self_class = this;
		return $.ajax({
			method: this.method,
			url: this.action,
			xhrFields: { 
				withCredentials: true 
			},
			data: form_data,
			cache: false,
			processData: false,
			contentType: false,
			crossDomain: true,
			enctype: 'multipart/form-data',
			success: function(data) {
				let data_json = JSON.parse(data);
				let notices_container = self_class.getNoticesContainer();
				
				if (data_json.messageType == 0) {
					//$(notices_container).html(self_class.getNoticeBlock(data_json.message, 0));
				}
				
				if (data_json.messageType == 1) {
					//$(notices_container).html(self_class.getNoticeBlock(data_json.message, 1));
					if (form_self.id == 'F7483063958' || form_self.id == 'F4530549110' || form_self.id == 'F7495221083') {
						document.location.reload();
					}
					
					if (form_self.id == 'F8310749566') {
						$(form_self).css('display', 'none');
					}
					
					if (form_self.id == 'F7530786658') {
						document.location.replace('/admin/entry/edit?id=' + data_json.outputData.id);
					}
				}
				
				let popupNotification = new PopupNotification();
				
				switch (data_json.messageType) {
					case 0: popupNotification.setColorScheme('scheme_red'); break;
					case 1: popupNotification.setColorScheme('scheme_green'); break;
					default: popupNotification.setColorScheme('scheme_default'); break;
				}
				
				popupNotification.setString(data_json.message);
				popupNotification.build();
				popupNotification.show();
				
				if (typeof(data_json.outputData.redirect) != 'undefined') {
					document.location.replace(data_json.outputData.redirect);
				}
			},
			error: function(jqXHR, exception) {
				let notices_container = self_class.getNoticesContainer();
				$(notices_container).html(self_class.getNoticeBlock(jqXHR.responseText, 0));
			}
		});
	}
	
	getMethod() {
		let input_method = $(this.form).find('input[name="_method"]')[0];
		if (typeof(input_method) != 'undefined') {
			return $(input_method).val();
		}
		
		return $(this.form).attr('method');
	}
	
	getNoticesContainer() {
		return $(document).find('.form__notices[data-form-id="' + this.id + '"]')[0];
	}
	
	getNoticeBlock(content, type) {
		let notice = '';
		switch(type) {
			case 0: notice = '<section class="notice notice_red">	<section class="icon__container">' + Form.icon_warning + '</section><section class="content__container">' + content + '</section></section>'; break;
			case 1: notice = '<section class="notice notice_green">	<section class="icon__container">' + Form.icon_success + '</section><section class="content__container">' + content + '</section></section>'; break;
			case 2: notice = '<section class="notice notice_yellow">	<section class="icon__container">' + Form.icon_lamp + '</section><section class="content__container">' + content + '</section></section>'; break;
			case 3: notice = '<section class="notice notice_blue">	<section class="icon__container">' + Form.icon_info + '</section><section class="content__container">' + content + '</section></section>'; break;
			case 4: notice = '<section class="notice">	<section class="icon__container">' + Form.icon_default + '</section><section class="content__container">' + content + '</section></section>'; break;
		}
		
		return notice;
	}
}